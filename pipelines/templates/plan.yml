parameters:
  - name: tf_creds

stages:
  - stage: terraform_plan
    displayName: Terraform Plan
    jobs:
      - job: terraform_plan
        displayName: Terraform Plan
        workspace:
          clean: all
        steps:
          - task: DownloadSecureFile@1
            name: tf_creds
            inputs:
              secureFile: ${{ parameters.tf_creds }}

          - bash: |
              mkdir -p ~/.terraform.d

          - task: CopyFiles@2
            inputs:
              sourceFolder: $(Agent.TempDirectory)
              contents: ${{ parameters.tf_creds }}
              targetFolder: "~/.terraform.d"

          - task: Bash@3
            displayName: terraform plan
            name: plan # needed for result later
            inputs:
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: terraform plan
              workingDirectory: $(System.DefaultWorkingDirectory)/terraform
            env:
              TF_IN_AUTOMATION: true
