parameters:
  - name: direction
    default: up
    displayName: Migration Direction
    values:
      - up
      - down

variables:
  - group: infra
  - group: devops-dev
  - group: pg-dev

pool:
  vmImage: ubuntu-latest

trigger:
  batch: true
  branches:
    include:
      - master
      - main
  paths:
    include:
      - pipelines/db_migrate_dev.yml
      - node/**/*
      - migrations/**/*

resources:
  pipelines:
    - pipeline: infra
      source: leriksen.terraform
      trigger:
        branches:
          - master
          - main

stages:
  - stage: db_migrate
    displayName: Migrate DB
    jobs:
      - deployment: db_migrate
        displayName: Migrate DB
        workspace:
          clean: all
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UseNode@1
                  inputs:
                    version: $(node_version)
                    checkLatest: true

                - task: Npm@1
                  inputs:
                    command: ci
                    workingDir: node

                - task: Bash@3
                  displayName: Migrate DB
                  env:
                    PG_USER:     $(pguser)
                    PG_PASSWORD: $(pgpassword)
                    PG_HOST:     $(pghost)
                    PG_DATABASE: $(pgdatabase)
                    PG_PORT:     5432
                  inputs:
                    targetType: inline
                    workingDirectory: migrations
                    script: |
                      npx db-migrate ${{ parameters.direction }} --config database.json --dry-run --environment pg