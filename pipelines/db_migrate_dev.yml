parameters:
  - name: direction
    default: up
    displayName: Migration Direction
    values:
      - up
      - down

variables:
  - group: infra
  - group: devops-dev
  - group: pg-dev

pool:
  vmImage: ubuntu-latest

trigger:
  batch: true
  branches:
    include:
      - master
      - main
  paths:
    include:
      - pipelines/db_migrate_dev.yml
      - node/**/*
      - migrations/**/*

resources:
  pipelines:
    - pipeline: infra
      source: leriksen.terraform
      trigger:
        branches:
          - master
          - main

stages:
  - stage: db_migrate
    displayName: Migrate DB
    jobs:
      - deployment: db_migrate
        displayName: Migrate DB
        workspace:
          clean: all
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UseNode@1
                  inputs:
                    version: $(node_version)
                    checkLatest: true

                - task: Npm@1
                  inputs:
                    command: install
                    workingDir: node

                - task: Bash@3
                  displayName: Migrate DB
                  env:
                    PGUSER:            $(pguser)
                    PGPASSWORD:        $(pgpassword)
                    PGHOST:            $(pghost)
                    PGDATABASE:        $(pgdatabase)
                    PGPORT:            5432
                    DRY_RUN:           $(dry_run)
                    MIGRATE_DIRECTION: $(migrate_direction)
                    INIT_MIGRATE:      $(initial_migration)
                  inputs:
                    targetType: filePath
                    workingDirectory: scripts
                    filePath: migrate_sql.sh ../migrations