variables:
  - group: devops-dev
  - group: pg-dev

pool:
  vmImage: ubuntu-22.04

trigger: none
#  batch: true
#  branches:
#    include:
#      - master
#      - main
#  paths:
#    include:
#      - pipelines/cluster_config.yml

stages:
  - stage: config
    displayName: Config Cluster
    jobs:
      - deployment: config
        displayName: Config Cluster
        workspace:
          clean: all
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: get creds
                  inputs:
                    azureSubscription: $(service_connection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az aks get-credentials -n pg -g pg
                    addSpnToEnvironment: true
                - task: Bash@3
                  displayName: Install CSI Drivers
                  inputs:
                    targetType: inline
                    script: |
                      echo "Adding Helm repo for Secret Store CSI..."
                      helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
  
                      echo "Installing Secrets Store CSI Driver using Helm..."
                      kubectl create ns csi-driver
                      helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --namespace csi-driver
                      kubectl get pods --namespace=csi-driver

