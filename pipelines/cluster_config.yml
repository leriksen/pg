variables:
  - group: devops-dev
  - group: pg-dev

pool:
  vmImage: ubuntu-22.04

trigger:
  batch: true
  branches:
    include:
      - master
      - main
  paths:
    include:
      - pipelines/cluster_config.yml
      - helm/**/*

stages:
  - stage: config
    displayName: Config Cluster
    jobs:
      - deployment: config
        displayName: Config Cluster
        workspace:
          clean: all
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: KubectlInstaller@0

                - task: HelmInstaller@1

                - task: AzureCLI@2
                  displayName: Kubectl Config
                  inputs:
                    azureSubscription: $(service_connection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az aks get-credentials -n pg -g pg
                    addSpnToEnvironment: true

                - task: Bash@3
                  displayName: Install CSI Driver
                  inputs:
                    targetType: inline
                    script: |
                      echo "Adding Helm repo for Secret Store CSI..."
                      helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
                      
                      echo "Installing Secrets Store CSI Driver using Helm..."
                      ns_count=$(kubectl get namespaces -o json | jq -r '[.items[].metadata | select(.name=="csi-driver")] | length')
  
                      if [[ $ns_count -eq 0 ]]; then
                        echo create
                        kubectl create ns csi-driver
                      else
                        echo driver exists
                      fi
                      
                      helm upgrade --install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --namespace csi-driver
                      kubectl get pods --namespace=csi-driver

                - task: Bash@3
                  displayName: Install Azure KV CSI Driver
                  inputs:
                    targetType: inline
                    script: |  
                      echo "Installing Secrets Store CSI Driver with Azure Key Vault Provider..."

                      kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/deployment/provider-azure-installer.yaml --namespace csi-driver
                      kubectl get pods -n csi-driver

                - task: Bash@3
                  displayName: Install CSI Driver
                  inputs:
                    targetType: inline
                    script: |
                      echo "Installing Secrets Store CSI Driver..."

                      helm upgrade --install --create-namespace csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --namespace csi-driver
                      kubectl get pods --namespace=csi-driver

                - task: Bash@3
                  displayName: Install Azure AAD Pod Identity
                  inputs:
                    targetType: inline
                    script: |
                      echo "Installing Azure AAD Pod Identity to cluster..."

                      helm repo add aad-pod-identity https://raw.githubusercontent.com/Azure/aad-pod-identity/master/charts
                      helm install pod-identity aad-pod-identity/aad-pod-identity
                      kubectl get pods

                - task: HelmDeploy@0
                  displayName: Helm Package
                  inputs:
                    command: package
                    chartPath: helm/postgres-secrets
                    chartVersion: 0.1.0
                    destination: $(Build.ArtifactStagingDirectory)
                    arguments: --app-version $(Build.BuildNumber)
                    save: false

                - task: HelmDeploy@0
                  displayName: Helm Deploy
                  inputs:
                    namespace:                   $(environment)
                    connectionType:              Kubernetes Service Connection
                    kubernetesServiceConnection: sc-aks
                    command:                     upgrade
                    chartType:                   FilePath
                    chartPath:                   $(Build.ArtifactStagingDirectory)/postgres-secrets-0.1.0.tgz
                    chartVersion:                0.1.0
                    releaseName:                 postgres
                    valueFile:                   helm/postgres-secrets/values.yaml
                    arguments:                   --install --create-namespace