variables:
  - group: devops-dev
  - group: pg-dev
  - group: infra

pool: ipam-devops

trigger:
  batch: true
  branches:
    include:
      - master
      - main
  paths:
    include:
      - pipelines/aks_secret_drivers.yml

resources:
  pipelines:
    - pipeline: infra_deploy
      source: leriksen.terraform
      trigger:
        branches:
          - master
          - main

stages:
  - stage: secretproviderclass
    displayName: Config Secret Provider Drivers
    jobs:
      - deployment: secretproviderclass
        displayName: Config Secret Provider Drivers
        workspace:
          clean: all
        environment: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: KubectlInstaller@0

                - task: HelmInstaller@1

                - task: AzureCLI@2
                  displayName: Kubectl Config
                  inputs:
                    azureSubscription: sc-azure-pg
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az aks get-credentials --name pg --resource-group pg --overwrite-existing
                    addSpnToEnvironment: true

                - task: Bash@3
                  displayName: Install CSI Driver
                  inputs:
                    targetType: inline
                    script: |
                      echo "Adding Helm repo for Secret Store CSI..."
                      helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
                      
                      echo "Installing Secrets Store CSI Driver using Helm..."
                      out=$(helm upgrade --install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --create-namespace --namespace csi-driver)
                      rc=$?
                      
                      kubectl get pods --namespace=csi-driver
                      
                      exit $rc

                - task: Bash@3
                  displayName: Install Azure KV CSI Implementation
                  inputs:
                    targetType: inline
                    script: |  
                      echo "Installing Secrets Store Implementation for Azure Key Vault..."

                      kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/deployment/provider-azure-installer.yaml --namespace csi-driver
                      kubectl get pods -n csi-driver
